\NeedsTeXFormat{LaTeX2e}

\RequirePackage{calc}		 % использование вычислений
\RequirePackage{ifthen}		 % условные операторы
\RequirePackage{eso-pic}	 % добавление графики на задний фон
\RequirePackage{tikz}		 % отрисовка графики
\RequirePackage{everyshi}	 % вывод на каждой странице
\RequirePackage{lastpage}    % номер последней станицы
\RequirePackage{polyglossia} % для подключения шрифта GOST type A
\RequirePackage{setspace}	 % отступы между строками
\RequirePackage{makevar}	 % локально определённые счётчики
\RequirePackage{minibox}     % для использования команды '\\' внутри makebox
\RequirePackage{pbox} 		 % для вычисления ширины текста, включающего '\\'

\ProvidesPackage{G2-104-68}
         [2016/04/28 v1.00 GOST Frames]

\ProcessOptions\relax

\def\@gostFirstPage{3}

%% MACROS \spbox
%
% Создаёт \parbox с заданными в мм координатами 
% и заданного размера, содержащий текст.
%
%   #1: x (left, bottom)
%   #2: y (left, bottom)
%   #3: x (right, top)
%   #4: y (right, top)
%   #5: align
%   #6: text
%
\def\spbox#1#2#3#4#5#6{{%
	\setlength{\unitlength}{1mm}
	\put(#1,#2){%
		\var{boxwidth}{#3 - #1}%
		\var{boxheight}{#4 - #2}%
		%
		\makebox(\value{\boxwidth},\value{\boxheight})[#5]{#6}%
	}%
}}


% Шрифт для заполения рамок GOST type A
\newfontfamily\gostFont[
	Path = fonts/,
	Extension = .ttf,
	Ligatures = TeX,
	AutoFakeSlant = 0.26
]{GostTypeA} %  шрифт для штампов


%% ENVIRONMENT
%
% Выводит текст гарнитурой GOST type A и стилем italic
%
\newenvironment{envGostFont}
	{\itshape\gostFont}
	{\par}

%% MACROS \gostBox
%
% Создаёт \spbox с заданными в мм координатами.
% Гарнитура по ГОСТу, ширина текста зависит от размера
% блока, в который он вписан
%
%   #1: x (left, bottom)
%   #2: y (left, bottom)
%   #3: x (right, top)
%   #4: y (right, top)
%   #5: text
%   #6: text aling
%	#7: text enviroment
%
\newlength{\gostBoxTextLen}
\newlength{\gostBoxTrueLen}
\newlength{\gostBoxLen}
\def\gostBox#1#2#3#4#5#6#7{{
	%
	\newenvironment{envGost}{#7\envGostFont}{\par}%
	%
	\var{boxWidth}{#3 - #1}%
	\var{boxHeight}{#4 - #2}%
	\setlength\gostBoxTextLen{\widthof{\pbox{\textwidth}{#5}}}%
	\setlength{\gostBoxLen}{\value{\boxWidth}mm - 1.5mm}%  1.5mm - отступ от границ
	\setlength{\gostBoxTrueLen}{\value{\boxWidth}mm + 14pt}%  14pt - поправочный коэффициент
	%
	\ifthenelse{\lengthtest{\gostBoxTextLen > \gostBoxTrueLen}}{%
		\spbox{#1}{#2}{#3}{#4}{#6}{%
			\noindent\resizebox{\gostBoxLen}{\height}{%
				{\envGost%
					\minibox[#6]{#5}%
				}%
			}%	
		}%
	}{%
		\spbox{#1}{#2}{#3}{#4}{#6}{%
			\noindent\resizebox{!}{!}{%
				{\envGost%
					\minibox[#6]{#5}%
				}%
			}%	
		}%
	}%
}}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Макросы формирующие штампы
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%% MACROS \makeSecondSheetFrames
%
% Создаёт штамп для второго листа (ГОСТ 2.104)
%
\def\makeSecondSheetFrames{%
\begin{tikzpicture}[remember picture, overlay, x=1mm, y=1mm]%
	\draw[black, line  width=0.5mm] (20, 5) rectangle (205,292);%
	\draw[black, line  width=0.5mm] (20, 5) rectangle (205,5+40);%
	\draw[black, line  width=0.5mm] (20, 5) rectangle (20+65,5+40);%
	\draw[black, line  width=0.5mm] (20, 5) rectangle (20+65,5+30);%
	\draw[black, line  width=0.5mm] (20, 5) rectangle (205,5+25);%
	\foreach \n/\f in {10,15,...,45} {%
		\draw[black, line  width=0.25mm] (20, 5) rectangle (20+65,\f);%
	}%
	\foreach \n/\f in {10,25,48} {%
		\draw[black, line  width=0.5mm] (20, 5) rectangle (20+65-\f,5+40);%
	}%
	\draw[black, line  width=0.5mm] (20, 5+25) rectangle (20+7, 5+40);%
	%
	\draw[black, line  width=0.5mm] (205-50, 5) rectangle (205,5+25);%
	\draw[black, line  width=0.5mm] (205-50, 5) rectangle (205,5+15);%
	\foreach \n/\f in {0,35,40,45} {%
		\draw[black, line  width=0.5mm] (205-50, 5+15) rectangle (205-\f,5+20);%
	}%
	\draw[black, line  width=0.5mm] (205-50, 5+15) rectangle (205-35,5+25);%
	\draw[black, line  width=0.5mm] (205-50, 5+15) rectangle (205-20,5+25);%
\end{tikzpicture}%
}

%% MACROS \makeOtherSheetFrames
%
% Создаёт штамп для остальных листов (ГОСТ 2.104)
%
\def\makeOtherSheetFrames{%
\begin{tikzpicture}[remember picture, overlay, x=1mm, y=1mm]%
	\draw[black, line  width=0.5mm] (20, 5) rectangle (205,292);%
	\draw[black, line  width=0.5mm] (20, 292-14) rectangle (20+70,292);%
	\draw[black, line  width=0.5mm] (20, 5) rectangle (20+65,10);%
	\draw[black, line  width=0.25mm] (20, 5) rectangle (20+65,15);%
	\draw[black, line  width=0.5mm] (20, 5) rectangle (205,20);%
	\draw[black, line  width=0.5mm] (20, 5) rectangle (20+7,20);%
	\draw[black, line  width=0.5mm] (20, 5) rectangle (20+17,20);%
	\draw[black, line  width=0.5mm] (20, 5) rectangle (20+40,20);%
	\draw[black, line  width=0.5mm] (20, 5) rectangle (20+55,20);%
	\draw[black, line  width=0.5mm] (20, 5) rectangle (20+65,20);%
	\draw[black, line  width=0.5mm] (20, 5) rectangle (205-10,20);%
	\draw[black, line  width=0.5mm] (205-10,5) rectangle (205,5+8);%
\end{tikzpicture}%
}

%% MACROS \makeSecondSheetStrings
%
% Создаёт подписи для второго листа
% 
% Границы листа учтены за счёт положения рисунка (picture)
%
\def\makeSecondSheetStrings{%
	\unitlength=1mm%
	\begin{picture}(205,292)(-20,-5)%
		\gostBox{0}{25}{7}{30}{\small{Изм.}}{c}{}%
		\gostBox{7}{25}{17}{30}{\small{Лист}}{c}{}%
		\gostBox{17}{25}{40}{30}{\small{№ докум.}}{c}{}%
		\gostBox{40}{25}{55}{30}{\small{Подп.}}{c}{}%
		\gostBox{55}{25}{65}{30}{\small{Дата}}{c}{}%
		\gostBox{0}{20}{17}{25}{\small{ Разраб.}}{l}{}%
		\gostBox{0}{15}{17}{20}{\small{ Пров.}}{l}{}%
		\gostBox{0}{5}{17}{10}{\small{ Н.контр.}}{l}{}%
		\gostBox{0}{0}{17}{5}{\small{ Утв.}}{l}{}%
		\gostBox{135}{20}{150}{25}{\small{Лит.}}{c}{}%
		\gostBox{150}{20}{165}{25}{\small{Лист}}{c}{}%
		\gostBox{150}{15}{165}{20}{\small{\thepage}}{c}{}%
		\gostBox{165}{20}{185}{25}{\small{Листов}}{c}{}%
		\gostBox{165}{15}{185}{20}{\small{\pageref{LastPage}}}{c}{}%
		\gostBox{135}{-5}{185}{0}{\small{Формат A4}}{c}{}%
		\gostBox{65}{-5}{135}{0}{\small{Копировал}}{c}{}%
		% Пользовательские надписи
		\gostBox{65}{25}{185}{40}{\Large{\@gostklgi}}{c}{%
			\rule[-0.2\baselineskip]{0pt}{\baselineskip}%
		}%
		% Настройки размера заголовка конфигурируются пользователем
		\gostBox{65}{0}{135}{25}{\@gosttitledocument}{c}{\setstretch{0.9}}%
		\gostBox{18}{20}{40}{25}{\small{\@gostrazrabotchik}}{l}{}%
		\gostBox{18}{15}{40}{20}{\small{\@gostproveril}}{l}{}%
		\gostBox{18}{5}{40}{10}{\small{\@gostnormokontroler}}{l}{}%
		\gostBox{18}{0}{40}{5}{\small{\@gostutverdil}}{l}{}%
		% Настройки размера надписи ниже конфигурируются пользователем
		\gostBox{135}{0}{185}{15}{\@gosttitlecompany}{c}{\setstretch{1}}%
		\gostBox{135}{15}{140}{20}{\small{\@gostlitera}}{c}{}%
		\gostBox{55}{20}{65}{25}{\small{\@gostdate}}{c}{}%
	\end{picture}%
}

%% MACROS \makeOtherSheetStrings
%
% Создаёт подписи для остальных листов
%
% Границы листа учтены за счёт положения рисунка (picture)
%
\def\makeOtherSheetStrings{%
	\unitlength=1mm%
	\begin{picture}(205,292)(-20,-5)%
		\gostBox{0}{0}{7}{5}{\small{Изм.}}{c}{}%
		\gostBox{7}{0}{17}{5}{\small{Лист}}{c}{}%
		\gostBox{17}{0}{40}{5}{\small{№~докум.}}{c}{}%
		\gostBox{40}{0}{55}{5}{\small{Подп.}}{c}{}%
		\gostBox{55}{0}{65}{5}{\small{Дата}}{c}{}%
		\gostBox{175}{8}{185}{15}{\small{Лист}}{c}{}%
		\gostBox{175}{0}{185}{8}{\large{\thepage}}{c}{}%
		\gostBox{130}{-5}{185}{0}{\small{Формат A4}}{c}{}%
		\gostBox{65}{-5}{130}{0}{\small{Копировал}}{c}{}%
		\gostBox{0}{273}{70}{287}{\rotatebox{180}{\Large{\@gostklgi}}}{c}{%
			\rule[-1.1\baselineskip]{0pt}{\baselineskip}%	
		}%
		\gostBox{65}{0}{175}{15}{\Large{\@gostklgi}}{c}{%
			\rule[-0.2\baselineskip]{0pt}{\baselineskip}%
		}%
	\end{picture}%
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% После вывода  каждой страницы выполняем следующий
%% код для вывода штампов
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% Убераем ненужную нумерацию, так как нумерация будет в штампах
\pagestyle{empty}

\EveryShipout{%
	%
	\renewcommand\small{\@setfontsize\small{3.5mm}{4.2mm}\selectfont}%
	\renewcommand\large{\@setfontsize\large{5mm}{6mm}\selectfont}%
	\renewcommand\Large{\@setfontsize\Large{7mm}{8.4mm}\selectfont}%
	\renewcommand\LARGE{\@setfontsize\LARGE{10mm}{12mm}\selectfont}%
	%
	\ClearShipoutPicture{%
		\ifnum \thepage = \@gostFirstPage
			\AddToShipoutPicture{%
				% Штамп для второго листа
				\makeSecondSheetFrames%
				% Подписи для второго листа
				\makeSecondSheetStrings%
			}%
		\else
			\ifnum \thepage > \@gostFirstPage
				\AddToShipoutPicture{%
					% Штамп для остальных листов
					\makeOtherSheetFrames%
					% Подписи для остальных листов
					\makeOtherSheetStrings
				}%
			\fi
		\fi%
	}%
}%

\endinput