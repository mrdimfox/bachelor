\NeedsTeXFormat{LaTeX2e}

\ProvidesPackage{diplom}
         [2016/05/03 v0.01 Package provide design Bachelor thesis at the University ITMO]
	
\RequirePackage{titlesec}		% оформление заголовков
\RequirePackage{titletoc}		% оформление содержания
\RequirePackage{listing}		% оформление списков
\RequirePackage{caption}		% оформление подписей
\RequirePackage{biblatex}		% библиография
\RequirePackage[titletoc]{appendix} % для приложений
\RequirePackage{chngcntr}  

\newif\ifmypackage@gostFrames

\DeclareOption{gostFrames}{
    \mypackage@gostFramestrue
}
\DeclareOption{noGostFrames}{
   \mypackage@gostFramesfalse
}

\DeclareOption{sf1p}{
	\newcommand{\firstPage}{1}
}

\DeclareOption{sf2p}{
	\newcommand{\firstPage}{2}
}

\DeclareOption{sf3p}{
	\newcommand{\firstPage}{3}
}

\DeclareOption{sf4p}{
	\newcommand{\firstPage}{4}
}


\ExecuteOptions{gostFrames}
\ExecuteOptions{sf3p}

\ProcessOptions\relax

\ifmypackage@gostFrames
    \RequirePackage{G2-105-95} % разное ГОСТовское барахло
    \RequirePackage{G2-104-68} % штампы и рамка
\else
    \RequirePackage[noframes]{G2-104-68}
    \RequirePackage[nogeometry]{G2-105-95}
\fi

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Титульный лист
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\gosttitlecompany{}
\gostnormokontroler{}
\gostrazrabotchik{}
\gostproveril{}
\gostklgi{}
\gosttitledocument{}
\gosttitleobject{~ }
\gostgrifutverjdeno{}
\gostgrifsoglasovano{}
\gostutverdil{}
\gostispolnitel{}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Центрирование содержания
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\renewcommand\tableofcontents{%
\clearpage
\begin{center}
    \Large{\textbf{Содержание}}
\end{center}    
    \large{\@starttoc{toc}}%
    \newpage
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Вид строчек в содержании
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\newcommand*\l@sectionx[2]{%
  \ifnum \c@tocdepth >\z@
    \addpenalty\@secpenalty
    %\addvspace{1em \@plus\p@}%
    \setlength\@tempdima{1em}%
    \begingroup
      \@tempdima 1.7 em\relax
      \parindent \z@ \rightskip \@pnumwidth
      \parfillskip -\@pnumwidth
      \leavevmode %\bfseries
      \advance\leftskip \@tempdima \null\nobreak\hskip -\leftskip
      {\hspace{0cm}{#1}\nobreak }%
      \leaders\hbox{%
        $\m@th
        \mkern \@dotsep mu\hbox{.} 
		$}\hfill%
      \nobreak%
     \hb@xt@\@pnumwidth{\hfil\large \normalcolor #2}%
     \par%
    \endgroup
  \fi
}

\renewcommand*\l@section[2]{%
  \ifnum \c@tocdepth >\z@
    \addpenalty\@secpenalty
    %\addvspace{1em \@plus\p@}%
    \setlength\@tempdima{1em}%
    \begingroup
      \@tempdima 0.5cm \relax
      \parindent \z@ \rightskip \@pnumwidth
      \parfillskip -\@pnumwidth
      \leavevmode %\bfseries
      \advance\leftskip \@tempdima \null\nobreak\hskip -\leftskip
      {\hspace{0cm}{#1}\nobreak }%
      \leaders\hbox{%
        $\m@th
       \mkern \@dotsep mu\hbox{.} 
		$}\hfill%
      \nobreak%
     \hb@xt@\@pnumwidth{\hfil\large \normalcolor #2}%
     \par%
    \endgroup
  \fi
}

\renewcommand*\l@subsection[2]{%
  \ifnum \c@tocdepth >\z@
    \addpenalty\@secpenalty%
    \setlength\@tempdima{1em}%
    \begingroup
      \@tempdima 0.8cm \relax
      \parindent \z@ \rightskip \@pnumwidth
      \parfillskip -\@pnumwidth
      \leavevmode %\bfseries
      \advance\leftskip \@tempdima \null\nobreak\hskip -\leftskip
      {\hspace{0cm}{#1}\nobreak }%
      \leaders\hbox{%
        $\m@th
        \mkern \@dotsep mu\hbox{.} 
		$}\hfill%
      \nobreak%
     \hb@xt@\@pnumwidth{\hfil\large \normalcolor #2}%
     \par%
    \endgroup
  \fi
}

% Вид подразделов в содержании
\dottedcontents{subsection}[15mm]{}{2em}{7pt}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Команды, формирующие представление названия раздела
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% Отвечает за представление номера раздела в тексте
\newcommand{\sectname}[2]{%
	\csname the#1\endcsname\quad
}

% Отвечает за представление номера раздела в содержании
\newcommand{\sectnameintoc}[2]{%
	\protect\numberline{\csname the#1\endcsname}%
}

% Команды между номером раздела и его названием
\newcommand{\sectdop}[1]{%
	\interlinepenalty \@M%
}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%% Взято из latex.ltx и исправлено под наши требования %%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\def\@sect#1#2#3#4#5#6[#7]#8{%
  \ifnum #2>\c@secnumdepth
    \let\@svsec\@empty
  \else
  % Если выводим нумерацию разделов
    \refstepcounter{#1}%
	% Здесь был @seccntformat
    \protected@edef\@svsec{\sectname{#1}{#2}\relax}%
  \fi
  \@tempskipa #5\relax
  \ifdim \@tempskipa>\z@
    \begingroup
      #6{%
	  	
	    % Выводится номер раздела
        \@hangfrom{\hskip #3\relax\@svsec}%
	% Выводится название раздела
	\raggedright%
          %\interlinepenalty \@M 
	\sectdop{#2}#8
	\@@par}%
    \endgroup
    \csname #1mark\endcsname{#7}%
    \ifnum #2>\c@tocdepth \else
      \addcontentsline{toc}{#1}{%
        \ifnum #2>\c@secnumdepth \else
          \sectnameintoc{#1}{#2}%
        \fi
        #7}%
    \fi
  \else
    \def\@svsechd{%
	\hyphenation{#8}%
      #6{\hskip #3\relax
      \@svsec #8}%
      \csname #1mark\endcsname{#7}%
      \addcontentsline{toc}{#1}{%
        \ifnum #2>\c@secnumdepth \else
          \protect\numberline{\csname the#1\endcsname}%
        \fi
        #7}}%
  \fi
  \@xsect{#5}}

\def\@xsect#1{%
  \@tempskipa #1\relax
  \ifdim \@tempskipa>\z@
    \par \nobreak
    \vskip \@tempskipa
    \@afterheading
  \else
    \@nobreakfalse
    \global\@noskipsectrue
    \everypar{%
      \if@noskipsec
        \global\@noskipsecfalse
       {\setbox\z@\lastbox}%
        \clubpenalty\@M
        \begingroup \@svsechd \endgroup
        \unskip
        \@tempskipa #1\relax
        \hskip -\@tempskipa
      \else
        \clubpenalty \@clubpenalty
        \everypar{}%
      \fi}%
  \fi
  \ignorespaces}

\renewcommand{\@biblabel}[1]{#1}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Правильная сортировака библиографии
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% Для макроса ниже обязательно должно быть заполнено поле language
% и не заполенено presort.
%\DeclareSourcemap{
%    \maps[datatype=bibtex]{
%        \map{
%            \step[fieldsource=language, match=russian, final]
%            \step[fieldset=presort, fieldvalue={a}]
%        }
%        \map{
%            \step[fieldsource=language, notmatch=russian, final]
%            \step[fieldset=presort, fieldvalue={z}]
%        }
%    }
%}

\DeclareSourcemap{
    \maps[datatype=bibtex]{
        \map{
            \step[fieldset=language, fieldvalue={tempruorder}]
        }
        \map[overwrite]{
            \step[fieldsource=language, match=russian, final]
            \step[fieldsource=presort, 
            match=\regexp{(.+)}, 
            replace=\regexp{aa$1}]
        }
        \map{
            \step[fieldsource=language, match=russian, final]
            \step[fieldset=presort, fieldvalue={az}]
        }
        \map[overwrite]{
            \step[fieldsource=language, notmatch=russian, final]
            \step[fieldsource=presort, 
            match=\regexp{(.+)}, 
            replace=\regexp{za$1}]
        }
        \map{
            \step[fieldsource=language, notmatch=russian, final]
            \step[fieldset=presort, fieldvalue={zz}]
        }
        \map{
            \step[fieldsource=language, match={tempruorder}, final]
            \step[fieldset=language, null]
        }
    }
}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Определение изменений в оформлении приложений
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\newcommand{\usebetterlinkanchor}[1]{%
    \gdef\Hy@chapapp{#1}%
}

% Среда для использования приложений
\newenvironment{appendicesGost}{%
    % Раздел приложения
    \newcommand{\appendixSection}[1]{
        \refstepcounter{section}
        \section*{##1}
        \addcontentsline{toc}{section}{\GostAsbuk{section}}
    }
    \begin{appendices}%
        \usebetterlinkanchor{appendixchapters}%
        \newcommand{\sectionbreak}{\clearpage}%
       	\setcounter{section}{0}%
       	\setcounter{subsection}{0}%
        \titleformat
            {\section} % command
            {\centering\Large\bf} % format
            {\appendixname~\GostAsbuk{section}} % label
            {0mm} % sep
            {%
                \\
                \centering
            } % before-code
        \titleformat
            {name=\section,numberless} % command
            {\centering\Large\bf} % format
            {\appendixname~\GostAsbuk{section}} % label
            {0mm} % sep
            {%
                \\
                \centering
            } % before-code
        % Нумерация рисунков с указанием номера приложения
        \counterwithin{figure}{section}%
        \renewcommand{\thefigure}{\GostAsbuk{section}.\arabic{figure}}%
        % Нумерация формул с указанием номера приложения
        \counterwithin{equation}{section}%
        \renewcommand{\theequation}{\GostAsbuk{section}.\arabic{equation}}%
        % Нумерация листингов с указанием номера приложения
        \counterwithin{lstlisting}{section}%
        \captionsetup[lstlisting]{labelformat=captionAppendix}%
        % Нумерация таблиц с указанием номера приложения
        \counterwithin{table}{section}%
        \captionsetup[table]{labelformat=captionAppendix}%
        \setcounter{tocdepth}{1}%
}{%
    \end{appendices}%
    \par%
}


%\renewcommand\appendix{\par
%      
%    \usebetterlinkanchor{appendixchapters}
%
%	\setcounter{tocdepth}{1}
%	\newcommand{\sectionbreak}{\clearpage}
%	
%	\titleformat
%	{\section} % command
%	{\centering\Large\bf} % format
%	{\appendixname~\GostAsbuk{section}} % label
%	{0mm} % sep
%	{%
%		\\
%		\centering
%	} % before-code
%    \renewcommand{\thesection}{\appendixname~\GostAsbuk{section}}%
%	
%	\setcounter{section}{0}%
%	\setcounter{subsection}{0}%
%	
%	% Отвечает за представление названия раздела в содержании
%%	\renewcommand{\sectnameintoc}[2]{%
%%		\ifnum ##2 > 1
%%			\protect\numberline{\csname the##1\endcsname}%
%%		\else
%%			\protect\appendixname\ \numberline{\csname the##1\endcsname}
%%		\fi
%%	}
%	
%	% Отвечает за перенесение названия раздела на другую строку в приложении
%%	\renewcommand{\sectdop}[1]{%
%%		\ifnum ##1 > 1
%%			%
%%		\else
%%			\\
%%		\fi
%%	}
%	
%	% Нумерация рисунков с указанием номера приложения
%	\@addtoreset{figure}{section}%       
%	\renewcommand{\thefigure}{\GostAsbuk{section}.\arabic{figure}}%
%	
%	% Нумерация формул с указанием номера приложения
%	\@addtoreset{equation}{section}%
%	\renewcommand{\theequation}{\GostAsbuk{section}.\arabic{equation}}%
%    
%    % Нумерация листингов с указанием номера приложения
%    \captionsetup[lstlisting]{labelformat=captionAppendix}
%
%    % Нумерация таблиц с указанием номера приложения                  
%    \captionsetup[table]{labelformat=captionAppendix}
%}

%\newcommand\appendix@section[1]{%
%	\refstepcounter{section}%
%	\orig@section*{\appendixname \@Alph\c@section: #1}%
%	\addcontentsline{toc}{section}{\appendixname \@Alph\c@section: #1}%
%}
%\let\orig@section\section
%\g@addto@macro\appendix{\let\section\appendix@section}

\endinput